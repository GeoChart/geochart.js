var geochartjs=geochartjs||{};geochartjs.utils=function(){"use strict";return{formatNumber:function(a){var b=a.toString().split(".");return b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,"'"),b.join(".")},retrieveGetArgumentsFromUrl:function(){for(var a=window.location.search.substr(1),b=a.split("&"),c={},d=0;d<b.length;d++){var e=b[d].split("=");"undefined"!==e[0]&&null!==e[0]&&(c[e[0]]=e[1])}return c}}}(jQuery),geochartjs.errorHandling=function(a,b){"use strict";function c(){var a="No data received",b="While trying to get the data from the database, an error occured and no data was transferred to the webpage. Please reload this page again.";e(a,b)}function d(){var a="Error occured",b="An error occured during execution. Please reload this page.";e(a,b)}function e(a,b){var c=$("#globalError");c.find(".title").text(a),c.find(".message").text(b),c.fadeIn("fast")}"undefined"!=typeof a&&null!==a?a.hasOwnProperty("error")?a.error.hasOwnProperty("title")&&a.error.hasOwnProperty("message")?e(a.error.title,a.error.message):d():"undefined"!=typeof b&&b():c()},geochartjs.map=function(a,b,c,d,e,f){"use strict";function g(b,c,d){a(eb.container).addClass("noControls"),i(b,c,d)}function h(a,b,c){lb=!0,i(a,b,c)}function i(d,g,h){$=d,_=g,ab=h,m(e.retrieveGetArgumentsFromUrl()),a(eb.container+" #mapList .csvDownload a").attr("href",o()),p(),r(),lb?a(eb.container).hide():b.json($,function(a){f(a,function(){Z=c.feature(a,a.objects[eb.mapName]),b.json(n(),function(a){f(a,function(){u(a),t(),Z=v(Z,a),k(),j(a.DATE),w(),H(),I()})})})}),J(),K(),L(),M(),N(),O()}function j(b){var c=a(eb.container+" #dateStamp");c.fadeOut("fast",function(){c.text(b),c.fadeIn()}),a(eb.container+" #mapList .list h2 .date").text("("+b+")")}function k(){var b=a(eb.container+" #mapList .list table tbody");b.empty(),b.loadTemplate(a("#mapListTableTemplate"),gb)}function l(){a(eb.container).slideUp("fast"),a(eb.container+" #mapList .csvDownload a").attr("href",o()),S.remove(),a(eb.container+" #mapLegend").fadeOut();var d=!0;p(d),b.json($,function(d){f(d,function(){Z=c.feature(d,d.objects[eb.mapName]),b.json(n(),function(b,c){f(c,function(){u(c),t(),Z=v(Z,c),k(),j(c.DATE),w(),H(),I(),a(eb.container).slideDown("slow"),a("html,body").animate({scrollTop:a(eb.container).offset().top},"slow")})})})})}function m(a){"undefined"!=typeof a&&("undefined"!=typeof a.date&&(fb.date=a.date),"undefined"!=typeof a.infoHash&&(fb.infoHash=a.infoHash))}function n(){var a=_;return null!==fb.date?(a+="?date="+fb.date,null!==fb.infoHash&&(a+="&infoHash="+fb.infoHash)):null!==fb.infoHash&&(a+="?infoHash="+fb.infoHash),a}function o(){var a=ab;return null!==fb.date?(a+="?date="+fb.date,null!==fb.infoHash&&(a+="&infoHash="+fb.infoHash)):null!==fb.infoHash&&(a+="?infoHash="+fb.infoHash),a}function p(c){S=b.select(eb.container).append("svg"),W=b.geo.equirectangular();var d="undefined"!=typeof c&&c&&lb;d&&(lb=!1),ob.isInFullscreen()?(d||(V=a(eb.container).height(),U=2*V),S.attr({width:a(eb.container).width(),height:a(eb.container).height()}),W.translate([U/2,V/2]).scale(U/2/Math.PI)):(d||(U=a(eb.container).width(),V=U/2),S.attr({width:U,height:V}),W.translate([U/2,V/2]).scale(U/2/Math.PI)),a(eb.container).removeClass(eb.smallMapClass),U<eb.thresholdToSmallMap&&a(eb.container).addClass(eb.smallMapClass),X=b.geo.path().projection(W),Y=b.behavior.zoom().scaleExtent(eb.zoomRange).on("zoom",G),T=S.append("g").style("opacity",0),S.call(Y).call(Y.event).on("click",q,!0),cb=a(window).width()}function q(){b.event.defaultPrevented&&b.event.stopPropagation()}function r(){b.select(window).on("resize",function(){var c=a(eb.container).is("."+eb.fullscreenClass),d=cb!==a(window).width();lb||mb&&!c||!c&&!d||(cb=a(window).width(),window.clearTimeout(bb),b.select(eb.container+" #mapOverlays").transition().duration(200).style("opacity",0),a(eb.container+" #mapLegend").hide(),bb=window.setTimeout(function(){s(),a("html,body").animate({scrollTop:a(eb.container).offset().top},"fast")},300))})}function s(){S.remove(),p(),F(void 0),w()}function t(){hb.domain([0,kb(jb)])}function u(a){jb=b.max(a.COUNTRIES,function(a){return parseInt(a.OBSERVED_PEERS,10)})}function v(a,b){gb=[];for(var c=0;c<b.COUNTRIES.length;c++){for(var d=!1,e=b.COUNTRIES[c].COUNTRY_CODE,f=parseInt(b.COUNTRIES[c].OBSERVED_PEERS,10),g=parseInt(b.COUNTRIES[c].MAX_SWARM_SIZE,10),h=parseFloat(b.COUNTRIES[c].PERCENTAGE),i=0;i<a.features.length;i++){var j=a.features[i].properties.iso_a2;e===j&&(a.features[i].properties.observedPeers=f,a.features[i].properties.maxSwarmSize=g,a.features[i].properties.percentage=h,d=!0,gb.push({ranking:c+1,observedPeers:f,maxSwarmSize:g,percentage:h,countryName:a.features[i].properties.name,countryCode:e,continent:a.features[i].properties.continent}))}d||gb.push({ranking:c+1,observedPeers:f,maxSwarmSize:g,percentage:h,countryName:e,countryCode:e,continent:void 0})}var k=parseInt(b.NOT_LOCATABLE_PEERS,10),l=parseFloat(b.NOT_LOCATABLE_PERCENTAGE);k>0&&gb.push({ranking:"&nbsp;",observedPeers:k,maxSwarmSize:"&ndash;",percentage:l,countryName:eb.notLocatableTitle,countryCode:eb.notLocatableTitle,continent:void 0});for(var m=0;m<gb.length;m++)gb[m].color=gb[m].countryName===eb.notLocatableTitle?db.mapListColorNotLocatable:ob.getColor({properties:{observedPeers:gb[m].observedPeers}});return a}function w(){T.selectAll("path").data(Z.features).enter().append("path").attr("d",X).style("fill",z).style("stroke-width",db.strokeWidthMax+"px").style("stroke",A).style("cursor",y).on("click",D).on("mouseover",B).on("mouseout",C),x(),T.transition().duration(700).style("opacity",1),b.select(eb.container+" #mapOverlays").transition().duration(700).style("opacity",1)}function x(){T.selectAll("path").each(function(b){if(!ob.hasPeerData(b)){var c=a(this).parent()[0],d=a(c).children().first()[0];c.insertBefore(this,d)}})}function y(a){return ob.hasPeerData(a)?"pointer":void 0}function z(a){return ob.hasPeerData(a)?ob.getColor(a):db.colorNoData}function A(a){return ob.hasPeerData(a)?ob.getStrokeColor(a):db.strokeColor}function B(b){var c=a(eb.container+" #colorLegend .zero .triangle"),d=a(eb.container+" #colorLegend .bar .triangle");if(ob.hasPeerData(b)){var e=ob.getPercentageBetweenUpperAndLowerColor(b),f=100*e+"%";d.css("left",f),c.hide(),d.show()}else c.show(),d.hide()}function C(){var b=a(eb.container+" #colorLegend .zero .triangle"),c=a(eb.container+" #colorLegend .bar .triangle");b.hide(),c.hide()}function D(a){var c=b.rgb(db.selectedColor).toString(),d=b.rgb(b.select(this).style("fill")).toString(),e=c===d;ob.hasPeerData(a)&&!e&&(T.selectAll("path").style("fill",z).style("stroke",A),b.select(this.parentNode.appendChild(this)).transition().style({fill:db.selectedColor,stroke:db.selectedStrokeColor}),E(a),F(a))}function E(b){a("#mapLegend").fadeIn(),a("#mapLegend").loadTemplate(a("#mapLegendTemplate"),b.properties)}function F(b){var c=a(eb.container+" #mapList .list"),d=c.find("table tbody tr");if(d.removeClass("selected"),"undefined"!=typeof b){var e=b.properties.iso_a2;d.each(function(){a(this).data("country-code")===e&&a(this).addClass("selected")})}}function G(){b.event.scale<1&&(b.event.scale=1);var a=b.event.translate,c=b.event.scale;a=P(a,c),Q(c),T.selectAll("path").style("stroke-width",ib(c)+"px"),T.attr("transform","translate("+a+")scale("+c+")")}function H(){a(eb.container+" #functionSelect").fadeIn()}function I(){a(eb.container+" #colorLegend .bar").css({"background-image":"linear-gradient(to right, "+db.colorRangeStart+" 10%, "+db.colorRangeEnd+" 100%)"}),a(eb.container+" #colorLegend .zero").css({"background-color":db.colorNoData}),a(eb.container+" #colorLegend .zero .value").text("0"),a(eb.container+" #colorLegend .bar .value").text(e.formatNumber(jb)),a(eb.container+" #colorLegend").fadeIn()}function J(){function b(b){var c=!a(this).hasClass("deactivated"),d=b.zoomIn===!0||b.zoomIn===!1;if(c&&d){var e=Y.scale(),f=Y.translate(),g=[f[0]-U/2,f[1]-V/2],h=Math.round(b.zoomIn?e+1:e-1),i=[g[0]/e*h,g[1]/e*h],j=[i[0]+U/2,i[1]+V/2];j=P(j,h),S.transition().duration(100).call(h>=eb.zoomRange[0]&&h<=eb.zoomRange[1]?Y.scale(h).translate(j).event:h>eb.zoomRange[1]?Y.scale(eb.zoomRange[1]).translate(j).event:Y.scale(eb.zoomRange[0]).translate(j).event)}}a(eb.container+" #zoom .plus").click(function(){b.apply(this,[{zoomIn:!0}])}),a(eb.container+" #zoom .minus").click(function(){b.apply(this,[{zoomIn:!1}])})}function K(){a(eb.container+" #fullscreen").click(function(){a(this).is(":not(:hidden)")&&(a(eb.container).addClass(eb.fullscreenClass),a("html").css({overflow:"hidden"}),a(eb.container+" #mapLegend").fadeOut(),a(this).fadeOut(),a(eb.container+" #fullscreenReturn").fadeIn(),s())}),a(eb.container+" #fullscreenReturn").click(function(){a(this).is(":not(:hidden)")&&(a(eb.container).removeClass(eb.fullscreenClass),a("html").css({overflow:"visible"}),a(eb.container+" #mapLegend").fadeOut(),a(this).fadeOut(),a(eb.container+" #fullscreen").fadeIn(),s())})}function L(){var b=a(eb.container+" #mapList .list"),c=a(eb.container+" #mapList .showButton"),d=a(eb.container+" #mapList .hideButton"),e=a(eb.container+" #dateStamp"),f=a(eb.container+" #fullscreenReturn");c.click(function(){b.animate({right:0}),a("#mapLegend").animate({right:b.outerWidth()+15},{complete:function(){f.data("top",f.css("top")).data("right",f.css("right")),f.animate({top:"22px",right:"27px"})}}),d.animate({right:b.outerWidth()+15}),c.fadeOut(),e.fadeOut()}),d.click(function(){b.animate({right:-(b.outerWidth()+20)}),a("#mapLegend").animate({right:"15px"}),f.animate({top:f.data("top"),right:f.data("right")}),d.animate({right:"-70px"}),c.fadeIn(),e.fadeIn()})}function M(){a(eb.container+" #functionSelect").change(function(){kb=nb[a(this).find("option:selected").val()],t(),a("#mapLegend").hide(),s()})}function N(){a("body").on("mapInfoHashChange",function(a,b){fb.infoHash=b.infoHash,l()})}function O(){a("body").on("mapDateChange",function(b,c){"undefined"==typeof c.date?(a(eb.container).slideUp("fast"),lb=!0):(fb.date=c.date,l())})}function P(b,c){if(ob.isInFullscreen()){var d=(a(eb.container).width()-U)*c-a(eb.container).width()*(c-1);b[0]=Math.min(0,Math.max(d,b[0]))}else b[0]=Math.min(0,Math.max(U*(1-c),b[0]));return b[1]=Math.min(0,Math.max(V*(1-c),b[1])),b}function Q(b){var c=.05;b<eb.zoomRange[0]+c?(a(eb.container+" #zoom .minus").addClass("deactivated"),a(eb.container+" #zoom .plus").removeClass("deactivated")):b>eb.zoomRange[1]-c?(a(eb.container+" #zoom .plus").addClass("deactivated"),a(eb.container+" #zoom .minus").removeClass("deactivated")):(a(eb.container+" #zoom .plus").removeClass("deactivated"),a(eb.container+" #zoom .minus").removeClass("deactivated"))}function R(){mb=!0}var S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db={selectedColor:"#FFE700",selectedStrokeColor:"#000000",strokeColor:"#CCC",strokeWidthMin:"0.07",strokeWidthMax:"0.3",colorRangeStart:"rgb(182,218,195)",colorRangeEnd:"rgb(7,84,37)",colorNoData:"#efefef",mapListColorNotLocatable:"#CCC"},eb={container:".geochart-map",zoomRange:[1,9],mapName:"ne_50m_admin_0_countries",hasDataClass:"hasData",fullscreenClass:"fullscreen",notLocatableTitle:"Not Locatable",thresholdToSmallMap:600,smallMapClass:"smallMap"},fb={infoHash:null,date:null},gb=[],hb=b.scale.linear().range([0,1]),ib=b.scale.linear().domain(eb.zoomRange).range([db.strokeWidthMax,db.strokeWidthMin]),jb=0,kb=Math.log,lb=!1,mb=!1,nb={log:function(a){return Math.log(a)},linear:function(a){return a},quadratic:function(a){return Math.pow(a,2)},sqrt:function(a){return Math.sqrt(a)},cubicroot:function(a){return Math.pow(a,1/3)},neginverse:function(a){return-1/a+1}},ob={};return ob.hasPeerData=function(a){return"undefined"!=typeof a.properties.observedPeers},ob.getPercentageBetweenUpperAndLowerColor=function(a){var b=a.properties.observedPeers,c=kb(b);return hb(c)},ob.getColor=function(a){var c=ob.getPercentageBetweenUpperAndLowerColor(a),d=b.interpolateRgb(db.colorRangeStart,db.colorRangeEnd);return d(c)},ob.getStrokeColor=function(a){return b.rgb(ob.getColor(a)).darker().toString()},ob.isInFullscreen=function(){return a(eb.container).hasClass(eb.fullscreenClass)},{init:i,initHidden:h,initWithoutControls:g,makeFixedSize:R}}(jQuery,d3,topojson,moment,geochartjs.utils,geochartjs.errorHandling);